{% extends 'base.html' %}{% block content %}<h2>Nodes</h2><section class='grid-2'><div class='card'><h3>Add node</h3><form method='post' action='/nodes/add'><div class='grid-2'><label>Host/IP <input name='host' required></label><label>User <input name='user' value='ubuntu' required></label></div><div class='grid-3'><label>SSH port <input type='number' name='port' value='22'></label><label>Auth <select name='auth_type' id='auth_type' onchange='toggleAuth()'><option value='password' selected>Password</option><option value='key'>SSH key</option></select></label><label id='pass_lbl'>Password <input type='password' name='password'></label><label id='key_lbl' style='display:none;'>Key path <input type='text' name='key_path' placeholder='/root/.ssh/id_rsa'></label><label>WG UDP port <input type='number' name='wg_port' value='51820'></label><label>API port <input type='number' name='api_port' value='4050'></label></div><div class='grid-3'><label>Capacity (Mbps) <input type='number' step='0.1' name='capacity_mbps' placeholder='e.g. 100'></label><label>Payout address (0xâ€¦) <input type='text' name='payout_address' placeholder='0x...'></label><label>Tags <input type='text' name='tags' placeholder='ru, pool-a'></label></div><label>Notes <input type='text' name='notes' placeholder='RU / city / ISP'></label><button type='submit'>Add</button></form></div><div class='card'><h3>Import/Export</h3><div class='bar'><a class='btn' href='/export' target='_blank'>Export JSON</a><a class='btn' href='/backup_db' target='_blank'>Backup DB</a><a class='btn' href='/metrics' target='_blank'>Prometheus /metrics</a></div><form method='post' action='/import_json' enctype='multipart/form-data' class='bar'><input type='file' name='file' required><button>Import JSON</button></form><form method='post' action='/import_csv_nodes' enctype='multipart/form-data' class='bar'><input type='file' name='file' required><button>Import CSV (nodes)</button></form><form method='post' action='/nodes/collect_all' class='bar'><button>Collect All</button></form><div class='muted'>CSV: host,user,port,auth,password,key_path,wg_port,api_port,capacity_mbps,tags,notes,payout_address</div></div></section><div class='card'><table id='tbl-nodes'><thead><tr><th onclick="sortTable('tbl-nodes',0)">ID</th><th onclick="sortTable('tbl-nodes',1)">Host</th><th onclick="sortTable('tbl-nodes',2)">SSH</th><th onclick="sortTable('tbl-nodes',3)">WG</th><th onclick="sortTable('tbl-nodes',4)">API</th><th onclick="sortTable('tbl-nodes',5)">Capacity</th><th onclick="sortTable('tbl-nodes',6)">Utilization</th><th onclick="sortTable('tbl-nodes',7)">NAT</th><th onclick="sortTable('tbl-nodes',8)">Sessions</th><th onclick="sortTable('tbl-nodes',9)">Avg Mbps</th><th onclick="sortTable('tbl-nodes',10)">Est. USD</th><th onclick="sortTable('tbl-nodes',11)">Last seen</th><th>Actions</th></tr></thead><tbody>{% for n in nodes %}<tr><td>{{n.id}}</td><td>{{n.host}}</td><td>{{n.port}}</td><td>{{n.wg_port}}</td><td>{{n.api_port}}</td><td>{{n.capacity_mbps or ''}}</td><td>{% if n.utilization_pct is not none %}{{n.utilization_pct}}%{% else %}-{% endif %}</td><td>{{n.nat_type}}</td><td>{{n.sessions}}</td><td>{{n.bandwidth_mbps}}</td><td>{{n.est_usd}}</td><td>{{n.last_seen or ''}}</td><td class='actions'><form method='post' action='/nodes/{{n.id}}/deploy'><button {% if n.myst_running %}disabled title='Already running'{% endif %}>Deploy</button></form><form method='post' action='/nodes/{{n.id}}/collect'><button>Collect</button></form><form method='post' action='/nodes/{{n.id}}/delete' onsubmit='return confirm("Delete node from list?");'><button>Delete</button></form></td></tr>{% endfor %}</tbody></table></div><script>function toggleAuth(){const v=document.getElementById('auth_type').value;document.getElementById('pass_lbl').style.display=v==='password'?'block':'none';document.getElementById('key_lbl').style.display=v==='key'?'block':'none';}function sortTable(tableId,colIndex){const table=document.getElementById(tableId);const tbody=table.tBodies[0];const rows=Array.from(tbody.querySelectorAll('tr'));const isNumeric=(v)=>/^-?\d+(\.\d+)?$/.test(v);const get=(tr)=>(tr.children[colIndex].innerText||'').trim();const asc=table.getAttribute('data-sort-dir')!=='asc';rows.sort((a,b)=>{const av=get(a),bv=get(b);if(isNumeric(av)&&isNumeric(bv))return (parseFloat(av)-parseFloat(bv))*(asc?1:-1);return av.localeCompare(bv)*(asc?1:-1);});rows.forEach(r=>tbody.appendChild(r));table.setAttribute('data-sort-dir',asc?'asc':'desc');}</script>{% endblock %}